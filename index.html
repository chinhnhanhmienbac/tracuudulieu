<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRA CỨU NGÀY NẠP CHAI THEO TEM CHỐNG GIẢ</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }

        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            margin: 20px;
            text-align: center;
        }

        .logo {
            display: block;
            margin: 0 auto 20px;
            max-width: 50%;
            height: auto;
        }

        h1, h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .section {
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        
        button#delete-button {
            background-color: #e74c3c;
        }

        button#delete-button:hover {
            background-color: #c0392b;
        }
        
        button#edit-button {
            background-color: #f39c12;
        }

        button#edit-button:hover {
            background-color: #e67e22;
        }

        button:hover {
            background-color: #2980b9;
        }

        .hidden {
            display: none;
        }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 8px;
            text-align: left;
        }

        .error-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            text-align: left;
        }

        .status-message {
            margin-top: 15px;
            font-weight: bold;
            color: #27ae60;
        }

        .editable-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

<div class="container">
    <img src="https://pvgaslpg.com.vn/uploads/LPG%20xanh%20animation.gif" alt="PVGas LPG Logo" class="logo">
    <h1>TRA CỨU NGÀY NẠP CHAI THEO TEM CHỐNG GIẢ</h1>
    
    <div id="lookup-section" class="section">
        <h2>Tra Cứu Dữ Liệu</h2>
        <div class="form-group">
            <label for="serial-input">Nhập số Serial cần tìm:</label>
            <input type="number" id="serial-input" placeholder="Ví dụ: 12345">
        </div>
        <button id="lookup-button">Tra cứu</button>
        <div id="lookup-result" class="result-box hidden"></div>
        <div id="lookup-error" class="error-box hidden"></div>
    </div>

    <button id="open-data-entry-button">Mở trang nhập liệu</button>

    <div id="login-section" class="section hidden">
        <h2>Đăng nhập</h2>
        <div class="form-group">
            <label for="username">Tên đăng nhập:</label>
            <input type="text" id="username" placeholder="admin">
        </div>
        <div class="form-group">
            <label for="password">Mật khẩu:</label>
            <input type="password" id="password" placeholder="Mật khẩu">
        </div>
        <button id="login-button">Đăng nhập</button>
        <div id="login-error" class="error-box hidden"></div>
    </div>

    <div id="data-entry-section" class="section hidden">
        <h2>Nhập Liệu</h2>
        <div class="form-group">
            <label for="date-input">Ngày:</label>
            <input type="date" id="date-input">
        </div>
        <div class="form-group">
            <label for="start-serial">Số bắt đầu:</label>
            <input type="number" id="start-serial" placeholder="Ví dụ: 1000">
        </div>
        <div class="form-group">
            <label for="end-serial">Số kết thúc:</label>
            <input type="number" id="end-serial" placeholder="Ví dụ: 1500">
        </div>
        <div class="form-group">
            <label for="location-input">Địa điểm:</label>
            <input type="text" id="location-input" placeholder="Ví dụ: Hà Nội">
        </div>
        <div style="display: flex; justify-content: space-between;">
            <button id="save-button">Lưu dữ liệu</button>
            <button id="export-button">Xuất ra Excel</button>
            <button id="delete-button">Xóa toàn bộ dữ liệu</button>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
            <button id="edit-button">Chỉnh sửa dữ liệu</button>
            <button id="logout-button">Đóng phần nhập liệu</button>
        </div>
        <div id="save-status" class="status-message"></div>
    </div>
    
    <div id="edit-data-section" class="section hidden">
        <h2>Chỉnh Sửa Dữ Liệu</h2>
        <div class="form-group">
            <label for="edit-date-input">Chọn ngày cần chỉnh sửa:</label>
            <input type="date" id="edit-date-input">
        </div>
        <button id="search-edit-button">Tìm dữ liệu</button>
        <div id="edit-list-container"></div>
        <div id="edit-status" class="status-message"></div>
        <button id="back-to-data-entry-button" style="margin-top: 20px;">Quay lại</button>
    </div>

</div>

<script>
    // Cấu hình Firebase từ file config.txt của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyBy1H9xX0qwnjpEQngFKpMq56L6VvMWqAI",
      authDomain: "cnmb-ce04d.firebaseapp.com",
      databaseURL: "https://cnmb-ce04d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cnmb-ce04d",
      storageBucket: "cnmb-ce04d.firebasestorage.app",
      messagingSenderId: "854586394737",
      appId: "1:854586394737:web:92825e9abc082db7da73d0",
      measurementId: "G-QH7VEVNFDL"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const dataRef = database.ref('serial_data');

    // Lấy các element từ HTML
    const loginSection = document.getElementById('login-section');
    const dataEntrySection = document.getElementById('data-entry-section');
    const lookupSection = document.getElementById('lookup-section');
    const editDataSection = document.getElementById('edit-data-section');
    const openDataEntryButton = document.getElementById('open-data-entry-button');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const saveButton = document.getElementById('save-button');
    const exportButton = document.getElementById('export-button');
    const deleteButton = document.getElementById('delete-button'); 
    const editButton = document.getElementById('edit-button'); 
    const lookupButton = document.getElementById('lookup-button');
    const searchEditButton = document.getElementById('search-edit-button');
    const backToDataEntryButton = document.getElementById('back-to-data-entry-button');

    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginError = document.getElementById('login-error');
    
    const dateInput = document.getElementById('date-input');
    const startSerialInput = document.getElementById('start-serial');
    const endSerialInput = document.getElementById('end-serial');
    const locationInput = document.getElementById('location-input');
    const saveStatus = document.getElementById('save-status');
    
    const serialInput = document.getElementById('serial-input');
    const lookupResult = document.getElementById('lookup-result');
    const lookupError = document.getElementById('lookup-error');

    const editDateInput = document.getElementById('edit-date-input');
    const editListContainer = document.getElementById('edit-list-container');
    const editStatus = document.getElementById('edit-status');

    // Hàm ẩn/hiện các phần
    function showLogin() {
        loginSection.classList.remove('hidden');
        dataEntrySection.classList.add('hidden');
        lookupSection.classList.add('hidden');
        editDataSection.classList.add('hidden');
        openDataEntryButton.classList.add('hidden');
    }

    function showDataEntry() {
        loginSection.classList.add('hidden');
        dataEntrySection.classList.remove('hidden');
        lookupSection.classList.add('hidden');
        editDataSection.classList.add('hidden');
        openDataEntryButton.classList.add('hidden');
        // Reset form
        dateInput.value = '';
        startSerialInput.value = '';
        endSerialInput.value = '';
        locationInput.value = '';
        saveStatus.textContent = '';
    }
    
    function showEditData() {
        loginSection.classList.add('hidden');
        dataEntrySection.classList.add('hidden');
        lookupSection.classList.add('hidden');
        editDataSection.classList.remove('hidden');
        openDataEntryButton.classList.add('hidden');
        // Clear edit form
        editDateInput.value = '';
        editListContainer.innerHTML = '';
        editStatus.textContent = '';
    }

    function showLookup() {
        loginSection.classList.add('hidden');
        dataEntrySection.classList.add('hidden');
        lookupSection.classList.remove('hidden');
        editDataSection.classList.add('hidden');
        openDataEntryButton.classList.remove('hidden');
        // Clear result
        lookupResult.classList.add('hidden');
        lookupError.classList.add('hidden');
        lookupResult.innerHTML = '';
        lookupError.innerHTML = '';
    }

    // Sự kiện mở trang nhập liệu
    openDataEntryButton.addEventListener('click', showLogin);

    // Sự kiện đăng nhập
    loginButton.addEventListener('click', () => {
        const username = usernameInput.value;
        const password = passwordInput.value;

        if (username === 'admin' && password === '12325') {
            showDataEntry();
            loginError.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
        } else {
            loginError.textContent = 'Thông tin đăng nhập không chính xác.';
            loginError.classList.remove('hidden');
        }
    });

    // Sự kiện đăng xuất
    logoutButton.addEventListener('click', () => {
        showLookup();
    });

    // Sự kiện mở phần chỉnh sửa dữ liệu
    editButton.addEventListener('click', () => {
        const editPassword = prompt('Nhập mật khẩu để chỉnh sửa dữ liệu:');
        if (editPassword === '13579') {
            showEditData();
        } else {
            alert('Mật khẩu không chính xác. Không thể chỉnh sửa dữ liệu.');
        }
    });

    // Sự kiện quay lại từ trang chỉnh sửa
    backToDataEntryButton.addEventListener('click', showDataEntry);

    // Sự kiện lưu dữ liệu
    saveButton.addEventListener('click', () => {
        const date = dateInput.value;
        const startSerial = parseInt(startSerialInput.value, 10);
        const endSerial = parseInt(endSerialInput.value, 10);
        const location = locationInput.value;

        if (date && !isNaN(startSerial) && !isNaN(endSerial) && location) {
            const newEntry = {
                date: date,
                start: startSerial,
                end: endSerial,
                location: location
            };

            dataRef.push(newEntry)
                .then(() => {
                    saveStatus.textContent = 'Lưu dữ liệu thành công!';
                    dateInput.value = '';
                    startSerialInput.value = '';
                    endSerialInput.value = '';
                    locationInput.value = '';
                })
                .catch(error => {
                    saveStatus.textContent = 'Lỗi: ' + error.message;
                    console.error('Lỗi khi lưu dữ liệu:', error);
                });
        } else {
            saveStatus.textContent = 'Vui lòng điền đầy đủ và đúng định dạng thông tin.';
        }
    });

    // Sự kiện xóa dữ liệu
    deleteButton.addEventListener('click', () => {
        const confirmPassword = prompt('Nhập mật khẩu để xóa dữ liệu:');
        if (confirmPassword === '54321') {
            dataRef.remove()
                .then(() => {
                    saveStatus.textContent = 'Tất cả dữ liệu đã được xóa thành công!';
                })
                .catch(error => {
                    saveStatus.textContent = 'Lỗi khi xóa dữ liệu: ' + error.message;
                    console.error('Lỗi khi xóa dữ liệu:', error);
                });
        } else {
            alert('Mật khẩu không chính xác. Không thể xóa dữ liệu.');
        }
    });

    // Hàm định dạng ngày tháng sang dd/mm/yyyy
    function formatDateForExcel(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString + 'T00:00:00'); // Add T00:00:00 to avoid timezone issues
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    // Sự kiện xuất Excel
    exportButton.addEventListener('click', () => {
        dataRef.once('value')
            .then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    const entries = Object.values(data).map(item => ({
                        'Ngày': formatDateForExcel(item.date), 
                        'Số bắt đầu': item.start,
                        'Số kết thúc': item.end,
                        'Địa điểm': item.location
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(entries);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Dữ liệu Serial");
                    
                    const now = new Date();
                    const dateStr = now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate();
                    XLSX.writeFile(wb, `DuLieuSerial_${dateStr}.xlsx`);
                    
                    saveStatus.textContent = 'Đã xuất file Excel thành công.';
                } else {
                    saveStatus.textContent = 'Không có dữ liệu để xuất.';
                }
            })
            .catch(error => {
                saveStatus.textContent = 'Lỗi khi lấy dữ liệu để xuất Excel: ' + error.message;
                console.error('Lỗi khi xuất Excel:', error);
            });
    });

    // Sự kiện tra cứu
    lookupButton.addEventListener('click', () => {
        const serialToFind = parseInt(serialInput.value, 10);

        if (isNaN(serialToFind)) {
            lookupError.textContent = 'Vui lòng nhập một số serial hợp lệ.';
            lookupError.classList.remove('hidden');
            lookupResult.classList.add('hidden');
            return;
        }

        lookupError.classList.add('hidden');
        lookupResult.classList.add('hidden');
        lookupResult.innerHTML = '';
        
        dataRef.once('value')
            .then(snapshot => {
                const data = snapshot.val();
                let found = false;
                if (data) {
                    for (let key in data) {
                        const entry = data[key];
                        if (serialToFind >= entry.start && serialToFind <= entry.end) {
                            lookupResult.innerHTML = `
                                <strong>Kết quả:</strong>
                                <br>
                                <p><strong>Ngày:</strong> ${entry.date}</p>
                                <p><strong>Địa điểm:</strong> ${entry.location}</p>
                            `;
                            lookupResult.classList.remove('hidden');
                            found = true;
                            break;
                        }
                    }
                }
                
                if (!found) {
                    lookupError.textContent = 'Không tìm thấy dữ liệu cho số serial này.';
                    lookupError.classList.remove('hidden');
                }
            })
            .catch(error => {
                lookupError.textContent = 'Lỗi khi tra cứu dữ liệu: ' + error.message;
                lookupError.classList.remove('hidden');
                console.error('Lỗi khi tra cứu:', error);
            });
    });
    
    // Sự kiện tìm kiếm dữ liệu để chỉnh sửa
    searchEditButton.addEventListener('click', () => {
        const dateToEdit = editDateInput.value;
        if (!dateToEdit) {
            editStatus.textContent = 'Vui lòng chọn ngày để tìm kiếm.';
            editStatus.style.color = '#f44336';
            return;
        }
        
        editListContainer.innerHTML = '';
        editStatus.textContent = '';
        
        dataRef.orderByChild('date').equalTo(dateToEdit).once('value')
            .then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    editStatus.textContent = 'Đã tìm thấy dữ liệu. Hãy chỉnh sửa và lưu lại.';
                    editStatus.style.color = '#27ae60';
                    for (let key in data) {
                        const entry = data[key];
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'editable-item';
                        itemDiv.innerHTML = `
                            <p><strong>Ngày:</strong> ${entry.date}</p>
                            <div class="form-group">
                                <label>Số bắt đầu:</label>
                                <input type="number" class="edit-start" value="${entry.start}">
                            </div>
                            <div class="form-group">
                                <label>Số kết thúc:</label>
                                <input type="number" class="edit-end" value="${entry.end}">
                            </div>
                            <div class="form-group">
                                <label>Địa điểm:</label>
                                <input type="text" class="edit-location" value="${entry.location}">
                            </div>
                            <button class="save-edit-button" data-key="${key}">Lưu thay đổi</button>
                        `;
                        editListContainer.appendChild(itemDiv);
                    }
                    
                    document.querySelectorAll('.save-edit-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const key = e.target.getAttribute('data-key');
                            const parentDiv = e.target.parentElement;
                            const newStart = parseInt(parentDiv.querySelector('.edit-start').value, 10);
                            const newEnd = parseInt(parentDiv.querySelector('.edit-end').value, 10);
                            const newLocation = parentDiv.querySelector('.edit-location').value;

                            if (!isNaN(newStart) && !isNaN(newEnd) && newLocation) {
                                const updates = {};
                                updates['/' + key] = {
                                    date: dateToEdit,
                                    start: newStart,
                                    end: newEnd,
                                    location: newLocation
                                };

                                dataRef.update(updates)
                                    .then(() => {
                                        editStatus.textContent = 'Cập nhật thành công!';
                                        editStatus.style.color = '#27ae60';
                                    })
                                    .catch(error => {
                                        editStatus.textContent = 'Lỗi khi cập nhật: ' + error.message;
                                        editStatus.style.color = '#f44336';
                                    });
                            } else {
                                editStatus.textContent = 'Vui lòng điền đầy đủ thông tin để lưu.';
                                editStatus.style.color = '#f44336';
                            }
                        });
                    });

                } else {
                    editStatus.textContent = 'Không tìm thấy dữ liệu nào cho ngày này.';
                    editStatus.style.color = '#f44336';
                }
            })
            .catch(error => {
                editStatus.textContent = 'Lỗi khi tìm kiếm dữ liệu: ' + error.message;
                editStatus.style.color = '#f44336';
                console.error('Lỗi khi tìm kiếm:', error);
            });
    });

</script>

</body>
</html>
