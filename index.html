<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Tra cứu Dữ liệu</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }

        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            margin: 20px;
            text-align: center;
        }

        h1, h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .section {
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }

        .hidden {
            display: none;
        }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 8px;
            text-align: left;
        }

        .error-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            text-align: left;
        }

        .status-message {
            margin-top: 15px;
            font-weight: bold;
            color: #27ae60;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Hệ thống Tra cứu Dữ liệu</h1>
    
    <div id="lookup-section" class="section">
        <h2>Tra Cứu Dữ Liệu</h2>
        <div class="form-group">
            <label for="serial-input">Nhập số Serial cần tìm:</label>
            <input type="number" id="serial-input" placeholder="Ví dụ: 12345">
        </div>
        <button id="lookup-button">Tra cứu</button>
        <div id="lookup-result" class="result-box hidden"></div>
        <div id="lookup-error" class="error-box hidden"></div>
    </div>

    <button id="open-data-entry-button">Mở trang nhập liệu</button>

    <div id="login-section" class="section hidden">
        <h2>Đăng nhập</h2>
        <div class="form-group">
            <label for="username">Tên đăng nhập:</label>
            <input type="text" id="username" placeholder="admin">
        </div>
        <div class="form-group">
            <label for="password">Mật khẩu:</label>
            <input type="password" id="password" placeholder="Nhập mật khẩu">
        </div>
        <button id="login-button">Đăng nhập</button>
        <div id="login-error" class="error-box hidden"></div>
    </div>

    <div id="data-entry-section" class="section hidden">
        <h2>Nhập Liệu</h2>
        <div class="form-group">
            <label for="date-input">Ngày:</label>
            <input type="date" id="date-input">
        </div>
        <div class="form-group">
            <label for="start-serial">Số bắt đầu:</label>
            <input type="number" id="start-serial" placeholder="Ví dụ: 1000">
        </div>
        <div class="form-group">
            <label for="end-serial">Số kết thúc:</label>
            <input type="number" id="end-serial" placeholder="Ví dụ: 1500">
        </div>
        <div class="form-group">
            <label for="location-input">Địa điểm:</label>
            <input type="text" id="location-input" placeholder="Ví dụ: Hà Nội">
        </div>
        <button id="save-button">Lưu dữ liệu</button>
        <button id="export-button">Xuất ra Excel</button>
        <button id="logout-button">Đóng phần nhập liệu</button>
        <div id="save-status" class="status-message"></div>
    </div>
</div>

<script>
    // Cấu hình Firebase từ file config.txt của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyBy1H9xX0qwnjpEQngFKpMq56L6VvMWqAI",
      authDomain: "cnmb-ce04d.firebaseapp.com",
      databaseURL: "https://cnmb-ce04d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cnmb-ce04d",
      storageBucket: "cnmb-ce04d.firebasestorage.app",
      messagingSenderId: "854586394737",
      appId: "1:854586394737:web:92825e9abc082db7da73d0",
      measurementId: "G-QH7VEVNFDL"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const dataRef = database.ref('serial_data');

    // Lấy các element từ HTML
    const loginSection = document.getElementById('login-section');
    const dataEntrySection = document.getElementById('data-entry-section');
    const lookupSection = document.getElementById('lookup-section');
    const openDataEntryButton = document.getElementById('open-data-entry-button');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const saveButton = document.getElementById('save-button');
    const exportButton = document.getElementById('export-button');
    const lookupButton = document.getElementById('lookup-button');

    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginError = document.getElementById('login-error');
    
    const dateInput = document.getElementById('date-input');
    const startSerialInput = document.getElementById('start-serial');
    const endSerialInput = document.getElementById('end-serial');
    const locationInput = document.getElementById('location-input');
    const saveStatus = document.getElementById('save-status');
    
    const serialInput = document.getElementById('serial-input');
    const lookupResult = document.getElementById('lookup-result');
    const lookupError = document.getElementById('lookup-error');

    // Hàm ẩn/hiện các phần
    function showLogin() {
        loginSection.classList.remove('hidden');
        dataEntrySection.classList.add('hidden');
        lookupSection.classList.add('hidden');
        openDataEntryButton.classList.add('hidden');
    }

    function showDataEntry() {
        loginSection.classList.add('hidden');
        dataEntrySection.classList.remove('hidden');
        lookupSection.classList.add('hidden');
        openDataEntryButton.classList.add('hidden');
        // Reset form
        dateInput.value = '';
        startSerialInput.value = '';
        endSerialInput.value = '';
        locationInput.value = '';
        saveStatus.textContent = '';
    }

    function showLookup() {
        loginSection.classList.add('hidden');
        dataEntrySection.classList.add('hidden');
        lookupSection.classList.remove('hidden');
        openDataEntryButton.classList.remove('hidden');
        // Clear result
        lookupResult.classList.add('hidden');
        lookupError.classList.add('hidden');
        lookupResult.innerHTML = '';
        lookupError.innerHTML = '';
    }

    // Sự kiện mở trang nhập liệu
    openDataEntryButton.addEventListener('click', showLogin);

    // Sự kiện đăng nhập
    loginButton.addEventListener('click', () => {
        const username = usernameInput.value;
        const password = passwordInput.value;

        if (username === 'admin' && password === '12345') {
            showDataEntry();
            loginError.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
        } else {
            loginError.textContent = 'Thông tin đăng nhập không chính xác.';
            loginError.classList.remove('hidden');
        }
    });

    // Sự kiện đăng xuất
    logoutButton.addEventListener('click', () => {
        showLookup();
    });

    // Sự kiện lưu dữ liệu
    saveButton.addEventListener('click', () => {
        const date = dateInput.value;
        const startSerial = parseInt(startSerialInput.value, 10);
        const endSerial = parseInt(endSerialInput.value, 10);
        const location = locationInput.value;

        if (date && startSerial && endSerial && location) {
            const newEntry = {
                date: date,
                start: startSerial,
                end: endSerial,
                location: location
            };

            dataRef.push(newEntry)
                .then(() => {
                    saveStatus.textContent = 'Lưu dữ liệu thành công!';
                    dateInput.value = '';
                    startSerialInput.value = '';
                    endSerialInput.value = '';
                    locationInput.value = '';
                })
                .catch(error => {
                    saveStatus.textContent = 'Lỗi: ' + error.message;
                    console.error('Lỗi khi lưu dữ liệu:', error);
                });
        } else {
            saveStatus.textContent = 'Vui lòng điền đầy đủ thông tin.';
        }
    });

    // Hàm định dạng ngày tháng sang DD/MM/YYYY
    function formatDate(dateString) {
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }

    // Sự kiện xuất Excel
    exportButton.addEventListener('click', () => {
        dataRef.once('value')
            .then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    const entries = Object.values(data).map(item => ({
                        'Ngày': formatDate(item.date), // Định dạng ngày tháng
                        'Số bắt đầu': item.start,
                        'Số kết thúc': item.end,
                        'Địa điểm': item.location
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(entries);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Dữ liệu Serial");
                    
                    const now = new Date();
                    const dateStr = now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate();
                    XLSX.writeFile(wb, `DuLieuSerial_${dateStr}.xlsx`);
                    
                    saveStatus.textContent = 'Đã xuất file Excel thành công.';
                } else {
                    saveStatus.textContent = 'Không có dữ liệu để xuất.';
                }
            })
            .catch(error => {
                saveStatus.textContent = 'Lỗi khi lấy dữ liệu để xuất Excel: ' + error.message;
                console.error('Lỗi khi xuất Excel:', error);
            });
    });

    // Sự kiện tra cứu
    lookupButton.addEventListener('click', () => {
        const serialToFind = parseInt(serialInput.value, 10);

        if (isNaN(serialToFind)) {
            lookupError.textContent = 'Vui lòng nhập một số serial hợp lệ.';
            lookupError.classList.remove('hidden');
            lookupResult.classList.add('hidden');
            return;
        }

        lookupError.classList.add('hidden');
        lookupResult.classList.add('hidden');
        lookupResult.innerHTML = '';
        
        dataRef.once('value')
            .then(snapshot => {
                const data = snapshot.val();
                let found = false;
                if (data) {
                    for (let key in data) {
                        const entry = data[key];
                        if (serialToFind >= entry.start && serialToFind <= entry.end) {
                            lookupResult.innerHTML = `
                                <strong>Kết quả:</strong>
                                <br>
                                <p><strong>Ngày:</strong> ${formatDate(entry.date)}</p>
                                <p><strong>Địa điểm:</strong> ${entry.location}</p>
                            `;
                            lookupResult.classList.remove('hidden');
                            found = true;
                            break;
                        }
                    }
                }
                
                if (!found) {
                    lookupError.textContent = 'Không tìm thấy dữ liệu cho số serial này.';
                    lookupError.classList.remove('hidden');
                }
            })
            .catch(error => {
                lookupError.textContent = 'Lỗi khi tra cứu dữ liệu: ' + error.message;
                lookupError.classList.remove('hidden');
                console.error('Lỗi khi tra cứu:', error);
            });
    });
</script>

</body>
</html>
